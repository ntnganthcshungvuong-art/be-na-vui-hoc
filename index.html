<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>🌸 Bé Na Vui Học 🌸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap');
    body { font-family: 'Baloo 2', sans-serif; }
    /* Popup động viên */
    .encouragement {
      position: fixed; bottom: 20px; right: 20px;
      max-width: 260px; background: rgba(255,255,255,0.95);
      border: 2px solid #fca5a5; border-radius: 16px; padding: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      animation: fadeInOut 3s ease forwards; z-index: 9999;
      font-size: 1rem;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translateY(20px); }
    }
    /* Rực rỡ đáp án */
    .option-button {
      padding: 1.2rem; margin-bottom: 0.7rem; border-radius: 1rem;
      font-size: 1.3rem; font-weight: 700; color: #fff;
      transition: transform 0.2s; width: 100%; display: block;
    }
    .option-button:nth-child(1){background:linear-gradient(135deg,#f59e0b,#fbbf24);}
    .option-button:nth-child(2){background:linear-gradient(135deg,#3b82f6,#60a5fa);}
    .option-button:nth-child(3){background:linear-gradient(135deg,#10b981,#34d399);}
    .option-button:nth-child(4){background:linear-gradient(135deg,#ec4899,#f472b6);}
    .option-button:active{transform:scale(1.05);}
  </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-yellow-50 to-blue-100 min-h-screen flex flex-col">

  <div class="max-w-4xl mx-auto p-4 flex-grow">
    <h1 class="text-4xl font-extrabold text-center mb-6 text-purple-700 animate-bounce">
      🌸 Bé Na Vui Học 🌸
    </h1>

    <!-- Màn hình chính -->
    <div id="homeScreen">
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <button ontouchstart onclick="startSubject('toan2.json','🔢 Toán 2')" class="p-6 rounded-2xl bg-blue-500 text-white font-bold text-xl">🔢<br>Toán 2</button>
        <button ontouchstart onclick="startSubject('tiengviet2.json','📘 Tiếng Việt 2')" class="p-6 rounded-2xl bg-green-500 text-white font-bold text-xl">📘<br>Tiếng Việt 2</button>
        <button ontouchstart onclick="startSubject('tnxh2.json','🌱 Tự nhiên & Xã hội 2')" class="p-6 rounded-2xl bg-yellow-500 text-white font-bold text-xl">🌱<br>Tự nhiên & Xã hội 2</button>
        <button ontouchstart onclick="startSubject('tienganh2.json','🌍 English 2')" class="p-6 rounded-2xl bg-red-500 text-white font-bold text-xl">🌍<br>English 2</button>
        <button ontouchstart onclick="startSubject('honhop.json','🎲 Hỗn hợp')" class="p-6 rounded-2xl bg-purple-500 text-white font-bold text-xl">🎲<br>Hỗn hợp</button>
      </div>
    </div>

    <!-- Màn hình chơi -->
    <div id="gameScreen" style="display:none;">
      <div class="bg-white rounded-2xl p-6 shadow-md min-h-[300px]">
        <div id="questionEmoji" class="text-5xl text-center mb-4">🤔</div>
        <h2 id="questionDisplay" class="text-2xl font-bold text-center mb-6">Câu hỏi...</h2>
        <div id="optionsContainer" class="space-y-3"></div>
      </div>
    </div>

    <!-- Màn hình kết quả -->
    <div id="resultScreen" style="display:none;">
      <div class="bg-white rounded-2xl p-6 text-center shadow-md">
        <div id="resultEmoji" class="text-6xl mb-4">🏆</div>
        <h2 id="resultTitle" class="text-2xl font-bold mb-4">Kết quả</h2>
        <div id="scoreDisplay" class="text-xl font-bold mb-2">0/0</div>
        <div id="percentDisplay" class="text-lg text-gray-700">0%</div>
        <div class="mt-4">
          <button ontouchstart onclick="goHome()" class="px-6 py-3 bg-purple-500 text-white rounded-xl text-lg">🏠 Trang chủ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup động viên -->
  <div id="encouragementMessage" class="encouragement" style="display:none;">
    <div class="text-center">
      <div class="text-lg font-bold text-red-600">Sai rồi!</div>
      <div class="text-sm text-gray-700">Đáp án đúng sẽ hiện nhé 🌟</div>
    </div>
  </div>

  <!-- Âm thanh -->
  <audio id="bgMusic" src="assets/bg-music.mp3" loop></audio>
  <audio id="correctSound" src="assets/correct.mp3"></audio>
  <audio id="wrongSound" src="assets/wrong.mp3"></audio>

<script>
let questions = [];
let currentIndex = 0, score = 0;

async function startSubject(file, title) {
  try {
    const r = await fetch('data/' + file + '?v=' + Date.now());
    if(!r.ok) throw new Error("Không tải được file " + file);
    const data = await r.json();
    questions = shuffleArray(data).slice(0,10);
    currentIndex=0; score=0;
    showScreen("gameScreen");
    playBgMusic();
    displayQuestion();
  } catch(err) {
    alert("❌ Lỗi tải dữ liệu: " + err.message);
    showScreen("homeScreen");
  }
}

function displayQuestion() {
  const q = questions[currentIndex];
  document.getElementById('questionEmoji').textContent = q.emoji || '❓';
  document.getElementById('questionDisplay').textContent = q.q;

  let container=document.getElementById('optionsContainer');
  container.innerHTML='';
  if(Array.isArray(q.options)){
    q.options.forEach((opt,i)=>{
      let btn=document.createElement('button');
      btn.className='option-button';
      btn.textContent = opt;
      btn.ontouchstart=()=>selectOption(i,q);
      btn.onclick=()=>selectOption(i,q);
      container.appendChild(btn);
    });
  }
}

function selectOption(index,q){
  const buttons=document.querySelectorAll('#optionsContainer button');
  buttons.forEach((btn,i)=>{
    btn.disabled=true;
    if(i===q.answer){
      btn.className='w-full block px-4 py-3 rounded-xl font-bold bg-green-500 text-white';
    }else if(i===index){
      btn.className='w-full block px-4 py-3 rounded-xl font-bold bg-red-500 text-white';
    }else{
      btn.className='w-full block px-4 py-3 rounded-xl bg-gray-200 text-gray-600';
    }
  });
  if(index===q.answer){ 
    score++; fireworks(); playCorrect(); 
  }
  else { 
    showEncouragement(q.options[q.answer]); playWrong(); 
  }
  setTimeout(()=>{nextQuestion();},2000);
}

function nextQuestion(){
  currentIndex++;
  if(currentIndex<questions.length){ displayQuestion(); }
  else { showResults(); stopBgMusic(); }
}

function showResults(){
  let percent=Math.round(score/questions.length*100);
  showScreen("resultScreen");
  document.getElementById('scoreDisplay').textContent=`${score}/${questions.length}`;
  document.getElementById('percentDisplay').textContent=`${percent}% ${percent>=90?"🏆 Xuất sắc!":percent>=70?"🌟 Tốt lắm!":percent>=50?"👍 Khá tốt!":"💪 Cố gắng hơn nhé!"}`;
}

function goHome(){ showScreen("homeScreen"); stopBgMusic(); }

function showScreen(id){
  ["homeScreen","gameScreen","resultScreen"].forEach(s=>{
    document.getElementById(s).style.display=(s===id)?"block":"none";
  });
}

function showEncouragement(correctAns){
  let box=document.getElementById('encouragementMessage');
  box.style.display="block";
  box.querySelector('.text-sm').innerHTML=`Đáp án đúng: <b>${correctAns}</b>`;
  setTimeout(()=>{box.style.display="none";},2500);
}

function fireworks(){
  let e=document.createElement('div');
  e.style.position='fixed'; e.style.left='50%'; e.style.top='50%';
  e.style.transform='translate(-50%,-50%)';
  e.style.fontSize='3rem'; e.textContent='🎉';
  document.body.appendChild(e);
  setTimeout(()=>document.body.removeChild(e),1000);
}

function playBgMusic(){ let m=document.getElementById('bgMusic'); m.volume=0.5; m.play().catch(()=>{}); }
function stopBgMusic(){ document.getElementById('bgMusic').pause(); }
function playCorrect(){ let s=document.getElementById('correctSound'); s.currentTime=0; s.play(); }
function playWrong(){ let s=document.getElementById('wrongSound'); s.currentTime=0; s.play(); }

function shuffleArray(a){return a.map(x=>({x,sort:Math.random()})).sort((a,b)=>a.sort-b.sort).map(({x})=>x);}
</script>
</body>
</html>
