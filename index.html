<script>
let currentQuestions = [];
let currentIndex = 0;
let score = 0;
let currentSubject = '';
let backgroundMusic = new Audio("assets/bg-music.mp3");
let correctSound = new Audio("assets/correct.mp3");
let wrongSound = new Audio("assets/wrong.mp3");

backgroundMusic.loop = true;
backgroundMusic.volume = 0.3;

function playMusic() {
  if (backgroundMusic.paused) backgroundMusic.play();
}

// ==== H√†m b·∫Øt ƒë·∫ßu game cho t·ª´ng m√¥n ====
function startMath() {
  fetch('data/toan2.json')
    .then(res => res.json())
    .then(data => {
      startGame('üî¢ To√°n 2', data);
    });
}

function startVietnamese() {
  fetch('data/tiengviet2.json')
    .then(res => res.json())
    .then(data => {
      startGame('üìò Ti·∫øng Vi·ªát 2', data);
    });
}

function startScience() {
  fetch('data/tnxh2.json')
    .then(res => res.json())
    .then(data => {
      startGame('üå± T·ª± nhi√™n & X√£ h·ªôi 2', data);
    });
}

function startEnglish() {
  fetch('data/tienganh2.json')
    .then(res => res.json())
    .then(data => {
      startGame('üåç English 2', data);
    });
}

function startMixed() {
  fetch('data/honhop.json')
    .then(res => res.json())
    .then(data => {
      startGame('üé≤ H·ªón h·ª£p', data);
    });
}

// ==== Logic game ====
function startGame(subject, questions) {
  currentSubject = subject;
  currentQuestions = shuffleArray(questions).slice(0, 10);
  currentIndex = 0;
  score = 0;
  playMusic();
  showScreen('gameScreen');
  displayQuestion();
}

function displayQuestion() {
  const question = currentQuestions[currentIndex];
  document.getElementById('subjectDisplay').textContent = currentSubject;
  document.getElementById('progressDisplay').textContent = `C√¢u ${currentIndex + 1}/${currentQuestions.length}`;
  document.getElementById('progressBar').style.width =
    `${((currentIndex + 1) / currentQuestions.length) * 100}%`;

  document.getElementById('questionDisplay').textContent = question.q;

  // Hi·ªÉn th·ªã ƒë√°p √°n
  const container = document.getElementById('optionsContainer');
  container.innerHTML = '';
  question.options.forEach((option, index) => {
    const btn = document.createElement('button');
    btn.className = 'option-button w-full p-5 text-center rounded-xl text-xl font-bold';
    btn.textContent = option;
    btn.onclick = () => selectOption(index);
    container.appendChild(btn);
  });
}

function selectOption(selectedIndex) {
  const question = currentQuestions[currentIndex];
  const isCorrect = selectedIndex === question.answer;
  const buttons = document.querySelectorAll('#optionsContainer button');

  buttons.forEach((btn, index) => {
    btn.disabled = true;
    if (index === question.answer) {
      btn.classList.add('bg-green-500', 'text-white');
      btn.textContent = `‚úÖ ${question.options[index]}`;
    } else if (index === selectedIndex) {
      btn.classList.add('bg-red-500', 'text-white');
      btn.textContent = `‚ùå ${question.options[index]}`;
    } else {
      btn.classList.add('opacity-50');
    }
  });

  if (isCorrect) {
    score++;
    correctSound.play();
    createFireworks();
  } else {
    wrongSound.play();
    showEncouragement(question.options[question.answer]);
  }

  setTimeout(() => nextQuestion(), 2000);
}

function nextQuestion() {
  if (currentIndex + 1 < currentQuestions.length) {
    currentIndex++;
    displayQuestion();
  } else {
    showResults();
  }
}

function showResults() {
  const percent = Math.round((score / currentQuestions.length) * 100);
  document.getElementById('scoreDisplay').textContent =
    `${score}/${currentQuestions.length} c√¢u ƒë√∫ng`;
  document.getElementById('percentDisplay').textContent = `${percent}%`;
  showScreen('resultScreen');
}

function playAgain() {
  startGame(currentSubject, currentQuestions);
}

function showScreen(screen) {
  ['homeScreen', 'gameScreen', 'resultScreen'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById(screen).style.display = 'block';
}

function goToHome() {
  showScreen('homeScreen');
}

// ==== Ti·ªán √≠ch ====
function shuffleArray(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function createFireworks() {
  const container = document.getElementById('fireworksContainer');
  for (let i = 0; i < 10; i++) {
    const dot = document.createElement('div');
    dot.className = 'firework';
    dot.style.left = Math.random() * 100 + '%';
    dot.style.top = Math.random() * 100 + '%';
    dot.style.background = 'hsl(' + Math.random() * 360 + ',100%,50%)';
    container.appendChild(dot);
    setTimeout(() => dot.remove(), 1000);
  }
}

function showEncouragement(correctAnswer) {
  const box = document.getElementById('encouragementMessage');
  box.innerHTML = `
    <div class="text-center">
      <div class="text-3xl mb-2">üí°</div>
      <div class="font-bold text-lg text-red-600">Sai r·ªìi!</div>
      <div class="text-sm">ƒê√°p √°n ƒë√∫ng: <b>${correctAnswer}</b></div>
    </div>
  `;
  box.style.display = 'block';
  setTimeout(() => (box.style.display = 'none'), 2000);
}
</script>
